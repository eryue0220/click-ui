#!/usr/bin/env node

// TODO: Move to .scripts/js once https://github.com/ClickHouse/click-ui/pull/784 is merged, or create a new PR while waiting for approval to introduce the file architecture change earliest

// TODO: rename scripts? decide if dashes or _ for script naming, maybe best _

import fs from 'fs';
import path from 'path';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';
import {
  filenameToKebabCase,
  filenameToComponentName,
  getComponentFiles,
  generateTypesContent,
  generateRegistryContent,
} from './shared/svg-converter-utils.mjs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const toPascalCase = (str) => {
  return str
    .replace(/[-_](.)/g, (_, char) => char.toUpperCase())
    .replace(/^(.)/, (_, char) => char.toUpperCase());
};

const ASSET_TYPES = {
  logos: {
    dir: path.join(__dirname, '..', 'src', 'components', 'Assets', 'Logos'),
    typeName: 'LogoName',
    registryName: 'LogosLight',
    defaultSize: 64,
  },
  icons: {
    dir: path.join(__dirname, '..', 'src', 'components', 'Assets', 'Icons'),
    typeName: 'IconName',
    registryName: 'IconsLight',
    defaultSize: 24,
  },
  flags: {
    dir: path.join(__dirname, '..', 'src', 'components', 'Assets', 'Flags'),
    typeName: 'FlagName',
    registryName: 'FlagsLight',
    defaultSize: 30,
  },
  payments: {
    dir: path.join(__dirname, '..', 'src', 'components', 'Assets', 'Payments'),
    typeName: 'PaymentName',
    registryName: 'PaymentsLight',
    defaultSize: 30,
  },
};

const getAssetType = (args) => {
  const typeFlag = args.find(arg => arg && arg.startsWith('--type='));

  const type = typeFlag.replace('--type=', '');

  if (typeof ASSET_TYPES[type] === 'undefined') {
    console.error(`üëπ Oops! Unknown type: ${type}. Use logos, icons, or flags`);
    process.exit(1);
  }

  return { type, config: ASSET_TYPES[type] };
};

const generateAssetTypes = (config) => {
  const files = getComponentFiles(config.dir);
  const sorted = files
    .map(name => ({ name, kebab: filenameToKebabCase(name) }))
    .sort((a, b) => a.kebab.localeCompare(b.kebab));

  const content = generateTypesContent(sorted, {
    typeName: config.typeName,
    themePropsType: config.themePropsType,
    importPath: '@/theme',
  });

  const systemDir = path.join(config.dir, 'system');
  fs.writeFileSync(path.join(systemDir, 'types.ts'), content);
};

const regenerateAssetRegistry = (config) => {
  const files = getComponentFiles(config.dir);
  const sorted = files
    .map(name => ({ name, kebab: filenameToKebabCase(name) }))
    .sort((a, b) => a.kebab.localeCompare(b.kebab));

  const systemDir = path.join(config.dir, 'system');

  const iconFiles = sorted.map(({ name, kebab }) => ({
    filename: name,
    componentName: name,
    kebab,
    exportType: 'default',
  }));

  const lightContent = generateRegistryContent(
    sorted,
    {
      registryName: config.registryName,
      typeName: config.typeName,
      themePropsType: config.themePropsType,
    },
    iconFiles,
    false
  );

  const darkContent = generateRegistryContent(
    sorted,
    {
      // TODO: The Light and dark theme should not be hard typed
      // once https://github.com/ClickHouse/click-ui/pull/784
      // is merged, update it
      registryName: config.registryName.replace('Light', 'Dark'),
      typeName: config.typeName,
      themePropsType: config.themePropsType,
    },
    iconFiles,
    true
  );

  fs.writeFileSync(
    path.join(systemDir, `${config.registryName}.ts`),
    lightContent
  );
  fs.writeFileSync(
    // TODO: The Light and dark theme should not be hard typed
    // once https://github.com/ClickHouse/click-ui/pull/784
    // is merged, update it
    path.join(systemDir, `${config.registryName.replace('Light', 'Dark')}.ts`),
    darkContent
  );
};

const convertSvgToComponent = (svgPath, componentName, outputPath, defaultSize) => {
  const svgrConfig = path.join(__dirname, '..', '.svgrrc.mjs');
  const cmd = `npx @svgr/cli --config-file "${svgrConfig}" --typescript "${svgPath}"`;

  let output;
  try {
    output = execSync(cmd, { encoding: 'utf8' });
  } catch (error) {
    console.error(`üëπ Oops! Failed to convert ${svgPath}:`, error.message);
    process.exit(1);
  }

  const constName = filenameToComponentName(componentName);

  output = output.replace(
    /const (\w+) = \(([^)]*)\)/,
    `const ${constName} = (props: SVGAssetProps)`
  );

  output = output.replace(
    /export default (\w+);$/m,
    `export default ${constName};`
  );

  output = output.replace(
    /(import \{ SVGAssetProps \} from ['"]\.\.\/types['"];)\n(const [^(]+ = )/,
    "import { SVGAssetProps } from './system/types';\n\n$2"
  );

  output = output.replace(/<svg([^>]*)>/, (match, attrs) => {
    let newAttrs = attrs
      .replace(/width="[^"]*"/, `width="${defaultSize}"`)
      .replace(/height="[^"]*"/, `height="${defaultSize}"`);
    if (!newAttrs.includes('width=')) newAttrs += ` width="${defaultSize}"`;
    if (!newAttrs.includes('height=')) newAttrs += ` height="${defaultSize}"`;
    return `<svg${newAttrs}>`;
  });

  fs.writeFileSync(outputPath, output);
};

const cleanUp = (files) => {
  let countErrors = 0;

  try {
    const eslintCmd = `npx eslint --fix --report-unused-disable-directives ${files.join(' ')}`;
    execSync(eslintCmd, { encoding: 'utf8', stdio: 'inherit' });
  } catch (error) {
    console.warn('‚ö†Ô∏è Lint fix failed due to', error.message);
    countErrors++;
  }

  try {
    const prettierCmd = `npx prettier --write --config .prettierrc ${files.join(' ')}`;
    execSync(prettierCmd, { encoding: 'utf8', stdio: 'inherit' });
  } catch (error) {
    console.warn('‚ö†Ô∏èCode format fix failed due to:', error.message);
    countErrors++;
  }

  if (countErrors > 0) {
    console.log('üí° Found some issues! In any case, you can test the component and make any further amends manually. If you find hard to troubleshoot report it immediately, please!');
  }
};

let args = process.argv.slice(2);

// WARN: Do not change as this extracts and removes the --type flag from args if present, to allow args in package.json scripts
const typeFlagIndex = args.findIndex(arg => arg.startsWith('--type='));
let typeFlag = null;
if (typeFlagIndex !== -1) {
  typeFlag = args[typeFlagIndex];
  args = args.filter((_, i) => i !== typeFlagIndex);
}

if (args.length < 1) {
  console.error('üëπ Oops! The SVG file path is required');
  console.error('üí° Usage: convert-svg-to-react-component <svg-path> [component-name] [--type=logos|icons|flags]');
  process.exit(1);
}

const svgPath = args[0];
let componentName = args[1];

const { type, config } = getAssetType(typeFlag ? [typeFlag] : []);

if (!componentName) {
  const basename = path.basename(svgPath, '.svg');
  componentName = toPascalCase(basename);
}

if (!componentName.match(/^[A-Z][a-zA-Z0-9_-]*$/)) {
  console.error('üëπ Oops! The component name must start with uppercase and use only letters, numbers, hyphens, or underscores.');
  process.exit(1);
}

if (type === 'icons' && componentName.length > 1) {
  const hasMultipleWords = componentName.includes('-');
  const isCamelCase = componentName.match(/[a-z][A-Z]/);

  if (isCamelCase && !hasMultipleWords) {
    console.error(`üëπ Icon name "${componentName}" must use dashes to separate words, e.g., Arrow-Down not ArrowDown.`);
    console.log(`üí° This ensures consistent kebab-case registry keys, e.g., 'arrow-down').`);
    process.exit(1);
  }
}

const outputPath = path.join(config.dir, `${componentName}.tsx`);
const systemDir = path.join(config.dir, 'system');
const typesPath = path.join(systemDir, 'types.ts');
const lightFile = path.join(systemDir, `${config.registryName}.ts`);
const darkFile = path.join(systemDir, `${config.registryName.replace('Light', 'Dark')}.ts`);

console.log(`üç© Baking ${componentName} for ${type}...`);

convertSvgToComponent(svgPath, componentName, outputPath, config.defaultSize);
generateAssetTypes(config);
regenerateAssetRegistry(config);

console.log(`üßπ Cleaning ${componentName}...\n`);
cleanUp([outputPath, typesPath, lightFile, darkFile]);

console.log(`\nüëç Done! Created ${componentName}`);
console.log('üí° Test it! When happy, remember to commit your changes');
